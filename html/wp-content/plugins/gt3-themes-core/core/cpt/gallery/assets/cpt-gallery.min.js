/*!
 Version: 1.0
 Author: GT3 Themes
 Website: https//gt3themes.com
 */
"use strict";jQuery(function(h){window.gt3=window.gt3||{};var k=gt3.views=gt3.views||{},c=gt3.models=gt3.models||{},e,i,a,g,l,f,d,j;e=c.Controller=Backbone.Model.extend({defaults:{maxFiles:0,ids:[],mimeType:"",forceDelete:false,length:0},initialize:function(m){if("$input" in m){this.$input=m.$input}var n=this;this.set("ids",_.without(_.map(this.get("ids"),Number),0,-1));this.set("items",new wp.media.model.Attachments());this.listenTo(this.get("items"),"add remove reset",function(){var p=this.get("items"),q=p.length,o=this.get("maxFiles");this.set("length",q);this.set("full",o>0&&q>=o)});this.on("destroy",function(o){if(this.get("forceDelete")){this.get("items").each(function(p){p.destroy()})}})},load:function(){var m=this;this.starting=true;if(!_.isEmpty(this.get("ids"))){this.get("items").props.set({query:true,include:this.get("ids"),orderby:"post__in",order:"DESC",type:this.get("mimeType"),perPage:this.get("maxFiles")||-1});this.get("items").more()}setTimeout(function(){m.starting=false;m.get("items").more()},1000)},removeItem:function(m){this.get("items").remove(m);if(this.get("forceDelete")){m.destroy()}this.saveToInput()},addItems:function(m){var n=this.get("items");h.each(m,function(p,o){n.add(o,{at:0})});this.saveToInput()},clearItems:function(n){if(confirm(i18n_GT3Media_Gallery.clearAllConfirm)||n===true){var m=this.get("items");while(this.get("items").length){m.remove(m.models[0]);m=this.get("items")}this.saveToInput()}},saveToInput:function(){var m=this.get("items").collect("id");this.$input.trigger("focus").val(m.join(",")).trigger("change").trigger("blur").trigger("input")},getItemsIds:function(){return this.get("items").collect("id")}});i=k.MediaField=Backbone.View.extend({initialize:function(m){var n=this;this.$input=h(m.input);this.controller=new e(_.extend({fieldName:this.$input.attr("name"),ids:this.$input.val().split(","),$input:this.$input,},this.$el.data()));this.createList();this.createAddButton();this.createClearButton();this.createStatus();this.render();this.controller.load();this.$input.on("remove",function(){n.controller.destroy()});this.controller.on("change:length",function(o){n.$input.trigger("change")})},createList:function(){this.list=new a({controller:this.controller})},createAddButton:function(){this.addButton=new l({controller:this.controller})},createClearButton:function(){this.clearButton=new f({controller:this.controller})},createStatus:function(){this.status=new j({controller:this.controller})},render:function(){this.$el.empty().append(this.addButton.el,this.clearButton.el,this.status.el,this.list.el)}});a=k.MediaList=Backbone.View.extend({tagName:"ul",className:"gt3-media-list",addItemView:function(n){var m=this._views[n.cid]=new this.itemView({model:n,controller:this.controller});if(this.controller.starting===true){this.$el.append(m.el)}else{this.$el.prepend(m.el)}},removeItemView:function(m){if(this._views[m.cid]){this._views[m.cid].remove();delete this._views[m.cid]}},initialize:function(m){this._views={};this.controller=m.controller;this.itemView=m.itemView||g;this.setEvents();this.initSortable()},setEvents:function(){this.listenTo(this.controller.get("items"),"add",this.addItemView);this.listenTo(this.controller.get("items"),"remove",this.removeItemView)},initSortable:function(){var m=this;var n=this.controller.get("items");this.$el.sortable({tolerance:"pointer",handle:".gt3-overlay",start:function(o,p){p.item.data("sortableIndexStart",p.item.index())},update:function(p,q){var o=n.at(q.item.data("sortableIndexStart"));n.remove(o,{silent:true});n.add(o,{silent:true,at:q.item.index()});n.trigger("reset",n);m.controller.saveToInput()}})}});j=k.MediaStatus=Backbone.View.extend({tagName:"span",className:"gt3-media-status",template:wp.template("gt3-media-status"),initialize:function(m){this.controller=m.controller;if(!this.controller.get("showStatus")){this.$el.hide()}this.listenTo(this.controller,"change:length",this.render);this.render()},render:function(){var m=_.clone(this.controller.attributes);this.$el.html(this.template(m))}});l=k.MediaButton=Backbone.View.extend({className:"gt3-add-media button button-primary",tagName:"a",events:{click:function(){if(this._frame){this._frame.dispose()}this._frame=wp.media({query:true,exclude:this.controller.getItemsIds(),className:"media-frame gt3-media-frame",multiple:true,title:i18n_GT3Media_Gallery.select,editing:true,library:{type:"image"},});this._frame.on("select",function(){var m=this._frame.state().get("selection");this.controller.addItems(m.models)},this);this._frame.open()}},render:function(){this.$el.text(i18n_GT3Media_Gallery.add);return this},initialize:function(m){this.controller=m.controller;this.listenTo(this.controller,"change:full",function(){this.$el.toggle(!this.controller.get("full"))});this.render()}});f=k.MediaClearButton=Backbone.View.extend({className:"gt3-clear-media button page-title-action",tagName:"a",events:{click:function(){this.controller.clearItems()}},render:function(){this.$el.text(i18n_GT3Media_Gallery.clearGallery);return this},initialize:function(m){this.controller=m.controller;this.render()}});g=k.MediaItem=Backbone.View.extend({tagName:"li",className:"gt3-media-item",template:wp.template("gt3-media-item"),initialize:function(m){this.controller=m.controller;this.render();this.listenTo(this.model,"change",function(){this.render()});this.$el.data("id",this.model.cid)},events:{"click .gt3-remove-media":function(m){this.controller.removeItem(this.model);return false},"click .gt3-edit-media":function(m){if(this._frame){this._frame.dispose()}this._frame=wp.media({frame:"edit-attachments",controller:{gridRouter:{navigate:function(n){},baseUrl:function(n){}}},library:this.controller.get("items"),model:this.model});this._frame.open();return false}},render:function(){var m=_.clone(this.model.attributes);m.fieldName=this.controller.get("fieldName");this.$el.html(this.template(m));return this}});d=k.ImageField=i.extend({createList:function(){this.list=new a({controller:this.controller,itemView:g.extend({className:"gt3-image-item",template:wp.template("gt3-image-item")})})}});function b(n,m){new d({input:m,el:h(m).siblings("div.gt3-media-view")})}h("input.gt3-image_advanced").each(b)});